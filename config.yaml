# === EXTRAS ===
debug: false
remove_outliers: false
exogen_features: false
cache: true

# === CONFIGURAÇÃO DOS DADOS ===
ds_col: mes
y_col: venda_unidades
time_col: ds           # ← importante pro MLForecast
target_col: y
id_col: unique_id             # ← seu unique_id (ajuste se for outro)

split_dates:
  train:
    start: '2023-01-01'
    end: '2025-01-01'
  test:
    start: '2025-02-01'
    end: '2025-07-01'

outlier:
  remove: false
  iqr_factor: 3.0
  season_length: 12

paths:
  data:
    raw_path: data/raw/
    interim_path: data/interim/
    processed_path: data/processed/
  models:
    candidates_model_path: models/candidates
    champion_model_path: models/champion
  plots:
    plots_path: plots/
  evaluation:
    evaluation_path: evaluation

min_time_series_length: 42
columns_selected: ['mes', 'venda_unidades']

# === HIERARQUIA ===
hierarchical_spec:
  - ['total']
  - ['total','produto']
  - ['total','produto','centro_distribuicao']
  - ['total','produto','centro_distribuicao',loja]
  #- ['total','centro_distribuicao','regiao_loja']
  #- ['total','centro_distribuicao','regiao_loja','clima_loja']
  #- ['total','centro_distribuicao','regiao_loja','clima_loja','loja']
  #- ['total','centro_distribuicao','regiao_loja','clima_loja','loja','produto']
  #- ['total','centro_distribuicao','regiao_loja','clima_loja','loja','produto','material']
  #- ['total','centro_distribuicao','regiao_loja','clima_loja','loja','produto','material','sku']

# === FEATURES ===
features:
  categorical_features:
    - cor
    - tamanho
    - padronagem
    - construcao
    - marca
    - decote
    - detalhe

  numerical_features:
    - estoque_unidades_inicio
    - estoque_unidades_fim
    - estoque_unidades
    - estoque_unidades_mediana
    - prop_dias_com_estoque
    - preco_unitario
    - desconto_percentual
    - desconto_absoluto
    - tem_preco_original
    - prop_dias_com_venda
    - total_observacoes_vendas
    - pedidos_m1
    - pedidos_m2
    - pedidos_m3
    - pedidos_m4
    - pedidos_m5
    - pedidos_m6
    - pedidos_m7  

  external_features:
    - weather_temperature
    - weather_preassure
    - weather_precipitation

  holiday_features:
    natal:
      dates: [2022-12-01, 2023-12-01, 2024-12-01, 2025-12-01]
      window_before: 3
      window_after: 1
    black_friday:
      dates: [2022-11-01, 2023-11-01, 2024-11-01, 2025-11-01]
      window_before: 2
      window_after: 1
    dia_maes:
      dates: [2022-05-01, 2023-05-01, 2024-05-01, 2025-05-01]
      window_before: 1
      window_after: 0
    carnaval:
      dates: [2022-02-01, 2023-02-01, 2024-02-01, 2025-02-01]
      window_before: 1
      window_after: 1

# === MODELOS (MULTI-MODEL FULL FLEX) ===
models:
  LightGBM:
    enabled: true
    type: mlforecast
    regressor: LGBMRegressor
    fixed_params:
      objective: poisson
      #boosting_type: gbdt
      #metric: mape
      #bagging_freq: 1
      #force_col_wise: true
      verbosity: -1
      n_jobs: -1
      #seed: 42
      #deterministic: true

  CatBoost:
    enabled: false
    type: mlforecast
    regressor: CatBoostRegressor
    fixed_params:
      loss_function: tweedie
      eval_metric: MAPE
      thread_count: -1
      verbose: false
      random_seed: 42
      cat_features: auto
      allow_writing_files: false

  XGBoost:
    enabled: false
    type: mlforecast
    regressor: XGBRegressor
    fixed_params:
      objective: reg:squarederror
      eval_metric: mape
      n_jobs: -1
      seed: 42
      tree_method: hist
      enable_categorical: true

  AutoARIMA: 
    enabled: false
    type: statsforecast
    fixed_params:
      season_length: 12
      approximation: true

  AutoETS:
    enabled: false
    type: statsforecast
    fixed_params:
      season_length: 12
      model: ZZZ
  
  AutoTheta:
    enabled: false
    type: statsforecast
    fixed_params:
      season_length: 12
      decomposition_type: multiplicative

  SeasonalNaive:
    enabled: false
    type: statsforecast
    fixed_params:
      season_length: 12

# === ESPAÇO DE BUSCA POR MODELO ===
parameter_space:
  LightGBM:
    float:
      learning_rate: {param: learning_rate, low: 0.01, high: 0.3, log: true}
      feature_fraction: {param: feature_fraction, low: 0.7, high: 1.0} 
      bagging_fraction: {param: bagging_fraction, low: 0.7, high: 1.0}
      lambda_l1: {param: lambda_l1, low: 1e-8, high: 1.0, log: true}
      lambda_l2: {param: lambda_l2, low: 1e-8,high: 1.0, log: true}
    int:
      num_leaves: {param: num_leaves, low: 8, high: 64}
      max_depth:  {param: max_depth, low: 3, high: 10}
      min_data_in_leaf: {param: min_data_in_leaf,low: 5, high: 20}
      n_estimators: {param: n_estimators, low: 300, high: 3000}

  CatBoost:
    learning_rate: {low: 0.01, high: 0.3, log: true}
    iterations: {low: 500, high: 5000, log: true}
    depth: {low: 4, high: 12}
    l2_leaf_reg: {low: 1, high: 10, log: true}
    bagging_temperature: {low: 0.0, high: 1.0}

  XGBoost:
    learning_rate: {low: 0.01, high: 0.3, log: true}
    n_estimators: {low: 500, high: 5000, log: true}
    max_depth: {low: 3, high: 15}
    min_child_weight: {low: 1, high: 100, log: true}
    subsample: {low: 0.6, high: 1.0}
    colsample_bytree: {low: 0.6, high: 1.0}
    reg_alpha: {low: 1e-8, high: 10.0, log: true}
    reg_lambda: {low: 1e-8, high: 10.0, log: true}

# === PRESETS DE FEATURES ===
modeling:
  training_metric:
    mase
  validation_metric:
    wrmsse
  compare_metrics:
    - wrmsse
    - smape
    - mase
    - rmsse 
    - rmse
    
  cv_config:
    h: 6
    n_windows: 6
    step_size: 1
  statsforecast:
    freq: MS
    time_col: ds
    target_col: y
    id_col: unique_id
    n_jobs: -1
  mlforecast:
    freq: MS
    time_col: ds
    target_col: y
    id_col: unique_id
    n_jobs: -1
    # === TUNING ATIVO ===
    tuning:
      search_lag_preset: true
      search_target_preset: true
      search_date_preset: true
      active_lag_preset: full_recent
      active_target_preset: none
      active_date_preset: full

    presets:
      # === PRESETS DE LAGS ===
      lag_strategies:
        none:
          lags: []
          transforms: {}
        only_seasonal:
          lags: [12]
          transforms: {}
        short_seasonal:
          lags: [6, 12]
          transforms:
            6: [rolling_mean_3]
            12: [rolling_mean_3]
        full_recent:
          lags: [1, 2, 3, 4, 5, 6, 12]
          transforms:
            1: [expanding_mean]
            6: [rolling_mean_3, rolling_mean_6]
            12: [expanding_mean, rolling_mean_3]
        ultra:
          lags: [1, 3, 6, 9, 12]
          transforms:
            1: [expanding_mean]
            3: [rolling_mean_3]
            6: [expanding_mean, rolling_mean_3, rolling_mean_6]
            12: [expanding_mean, rolling_mean_3, rolling_mean_6]

      # === PRESETS DO TARGET ===
      target_transforms:
        none: []
        detrend: [differences_1]
        boxcox: [boxcox]
        standardize: [standard_scaler]

      # === PRESETS DE DATA ===
      date_features:
        basic: [month, quarter]
        full: [month, quarter, is_month_start, is_month_end]

    

    fit_params:
      static_features:
        - []
      #  - sku
      #  - loja
      #  - produto
      #  - material
      #  - cor
      #  - tamanho
      #  - marca
      #  - clima_loja

    backtest:
      enabled: true
      n_months_test: 6
      
    validation:
      metric: rmse
      n_trials: 100
      timeout: 14400

# === ENSEMBLE ===
ensemble:
  enabled: true
  strategy: weighted_average
  method: backtest_performance
  min_weight: 0.05
  fallback: CatBoost

# === RECONCILIAÇÃO HIERÁRQUICA ===
reconciliation:
  enabled: true
  methods: [BottomUp,TopDown,MiddleOut,MinTrace]
  min_trace_methods: [wls_var,wls_struct,mint_shrink]
  middle_level: total/produto/centro_distribuicao

# === OPTUNA ===
optuna:
  direction: minimize
  n_trials: 80
  timeout: 14400
  sampler:
    type: TPESampler
    seed: 42
  pruner:
    type: MedianPruner
    n_startup_trials: 40
  metric: rmsse

# === DTYPES ===
dtypes:
  material: object
  sku: object
  produto: object
  cor: object
  tamanho: object
  construcao: object
  padronagem: object
  marca: object
  decote: object
  detalhe: object
  loja: object
  centro_distribuicao: object
  idade_loja: int
  uf_loja: object
  cidade_loja: object
  regiao_loja: object
  bairro_loja: object
  clima_loja: object
  perfil_loja: object
  porte_loja: object
  estoque_unidades_inicio: int
  estoque_unidades_fim: int
  estoque_unidades: int
  estoque_unidades_mediana: float
  prop_dias_com_estoque: float
  venda_unidades: int
  venda_valor_total: float
  preco_atual: float
  preco_original: float
  diff_preco: float
  etiqueta: object
  mes: datetime
  prop_dias_com_venda: float
  total_observacoes_vendas: int
  pedidos: int
  pedidos_m1: int
  pedidos_m2: int
  pedidos_m3: int
  pedidos_m4: int
  pedidos_m5: int
  pedidos_m6: int
  pedidos_m7: int
  pedidos_m8: int
  pedidos_m9: int
  pedidos_m10: int
  pedidos_m11: int
  pedidos_m12: int